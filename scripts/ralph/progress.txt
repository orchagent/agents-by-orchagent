# Ralph Progress Log
Started: 2026-01-15
Project: Building 4 OrchAgent Showcase Agents

## Codebase Patterns

### Project Structure (from leak-finder)
- Root: `agent-name/` at repo root
- Source: `src/agent_name/` (underscore, not hyphen)
- Tests: `tests/` at agent root
- Config: `pyproject.toml` with `[tool.setuptools.packages.find] where = ["src"]`

### orchagent.json
- `name`: kebab-case (matches directory)
- `version`: "v1", "v2", etc
- `type`: "code" or "prompt"
- `default_endpoint`: for code agents, the main endpoint name
- `source_url`: git+https://github.com/jp730/agents-by-orchagent.git#subdirectory=agent-name
- `run_command`: "python3 -m agent_name.cli" for code agents

### FastAPI Patterns
- App instance: `app = FastAPI(title="...", description="...", version="...")`
- Health endpoint: `@app.get("/health")` returning `{"status": "ok"}`
- Use Pydantic models for request/response validation
- Async endpoints: `async def endpoint_name(...)`
- Error handling: `raise HTTPException(status_code=400, detail="...")`

### Dockerfile Pattern
```dockerfile
FROM python:3.11-slim
WORKDIR /app
ENV PYTHONDONTWRITEBYTECODE=1 PYTHONUNBUFFERED=1
RUN apt-get update && apt-get install -y git && rm -rf /var/lib/apt/lists/*
COPY pyproject.toml ./
COPY src ./src
RUN pip install --no-cache-dir .
CMD ["sh", "-c", "uvicorn agent_name.main:app --host 0.0.0.0 --port ${PORT:-8000}"]
```

### pyproject.toml Pattern
```toml
[build-system]
requires = ["setuptools>=64", "wheel"]
build-backend = "setuptools.build_meta"

[project]
name = "agent-name"
version = "0.1.0"
requires-python = ">=3.11"
dependencies = [
    "fastapi>=0.109.0",
    "uvicorn>=0.27.0",
    "pydantic>=2.0.0",
    # ... other deps
]

[project.optional-dependencies]
dev = ["pytest>=8.0.0", "httpx>=0.26.0"]

[tool.setuptools.packages.find]
where = ["src"]
```

### Test Patterns
- Use `httpx.AsyncClient` with `ASGITransport` for testing FastAPI
- Test file: `tests/test_main.py`
- Fixture for test client
- Test health endpoint first

### Prompt-based Agent orchagent.json
```json
{
  "name": "agent-name",
  "version": "v1",
  "type": "prompt",
  "description": "...",
  "supported_providers": ["openai", "anthropic", "gemini"],
  "tags": [...],
  "prompt": "System prompt goes here...",
  "input_schema": { "type": "object", "properties": {...}, "required": [...] },
  "output_schema": { "type": "object", "properties": {...}, "required": [...] }
}
```

## Key Files Reference
- `leak-finder/orchagent.json` - manifest example
- `leak-finder/pyproject.toml` - dependencies pattern
- `leak-finder/Dockerfile` - container config
- `leak-finder/src/leak_finder/main.py` - FastAPI app
- `leak-finder/src/leak_finder/models.py` - Pydantic models
- `leak-finder/src/leak_finder/git_utils.py` - git clone pattern
- `docs/newagents/` - specs for each agent

---

## 2026-01-15 - DS-001
- What was implemented: Scaffolded dep-scanner project structure
- Files changed:
  - `dep-scanner/orchagent.json` - Agent manifest with type=code
  - `dep-scanner/pyproject.toml` - Python project config with fastapi, gitpython deps
  - `dep-scanner/Dockerfile` - Container config following leak-finder pattern
  - `dep-scanner/src/dep_scanner/__init__.py` - Package init
- **Learnings:**
  - Directory name uses kebab-case (dep-scanner) but module uses underscore (dep_scanner)
  - run_command should reference module path: `python3 -m dep_scanner.cli`
  - Dockerfile CMD should match module name with underscores
---

## 2026-01-15 - DS-002
- What was implemented: Created FastAPI app with /health and /scan endpoints
- Files changed:
  - `dep-scanner/src/dep_scanner/models.py` - Pydantic models (ScanRequest, Finding, ScanSummary, ScanResponse)
  - `dep-scanner/src/dep_scanner/main.py` - FastAPI app with /health and /scan endpoints
- **Learnings:**
  - ScanResponse follows spec from dep-scanner-agent.md with scan_id, detected_managers, findings, summary
  - Summary model has critical/high/medium/low counts plus total_packages_scanned
  - /scan endpoint returns stub with empty findings for now (actual logic in DS-003+)
---

## 2026-01-15 - DS-003
- What was implemented: Git clone to temp directory with cleanup
- Files changed:
  - `dep-scanner/src/dep_scanner/git_utils.py` - clone_repo, cleanup_repo, cloned_repo context manager
- **Learnings:**
  - Use shallow clone (depth=1) for dependency scanning - full history not needed
  - Added `cloned_repo` context manager to ensure automatic cleanup even on exceptions
  - GitPython's Repo.clone_from works seamlessly with both https:// and git@ URLs
  - Use `shutil.rmtree(path, ignore_errors=True)` for cleanup to handle locked files gracefully
---

## 2026-01-15 - DS-004
- What was implemented: npm audit scanning with JSON parsing
- Files changed:
  - `dep-scanner/src/dep_scanner/scanners/__init__.py` - Scanner package init
  - `dep-scanner/src/dep_scanner/scanners/npm.py` - npm audit scanner implementation
- **Learnings:**
  - npm audit v7+ uses `vulnerabilities` dict format, not old `advisories` array
  - npm uses "moderate" severity which must be mapped to "medium"
  - `via` field contains CVE details (can be objects or strings for transitive deps)
  - Use `--package-lock-only` flag when no node_modules exists for faster scanning
  - npm audit returns non-zero exit code when vulnerabilities found (not a failure)
  - Generate package-lock.json if missing using `npm install --package-lock-only`
---

## 2026-01-15 - DS-005
- What was implemented: pip-audit scanning for Python dependencies
- Files changed:
  - `dep-scanner/src/dep_scanner/scanners/pip.py` - pip-audit scanner implementation
  - `dep-scanner/src/dep_scanner/scanners/__init__.py` - Added exports for pip scanner
  - `dep-scanner/Dockerfile` - Added nodejs, npm, and pip-audit
  - `dep-scanner/pyproject.toml` - Added pip-audit>=2.6.0 dependency
- **Learnings:**
  - pip-audit JSON format returns array of dependencies with `vulns` array for each
  - pip-audit doesn't include severity directly; must infer from description keywords or default to "medium"
  - Support multiple Python dependency files: requirements.txt, pyproject.toml, Pipfile, setup.py
  - pip-audit uses `fix_versions` array, use first element for recommendation
  - CVE identifiers are in `aliases` array; prefer CVE- prefixed ones over GHSA- IDs
  - FileNotFoundError indicates pip-audit not installed; handle gracefully with warning log
  - Dockerfile needs both nodejs/npm for npm audit and pip-audit for Python scanning
---

## 2026-01-15 - DS-006
- What was implemented: Unified scanner orchestration module and main.py integration
- Files changed:
  - `dep-scanner/src/dep_scanner/scanner.py` - New orchestration module combining npm + pip scanners
  - `dep-scanner/src/dep_scanner/main.py` - Updated /scan endpoint to use scanner.py
- **Learnings:**
  - Use `cloned_repo` context manager to ensure cleanup even on exceptions
  - Models were already properly defined in DS-002 with all required fields
  - Scanner module provides clean separation between API layer and business logic
  - Auto-detection of package managers uses existing detect_npm and detect_python_deps functions
  - Summary is built by counting findings per severity level
  - GitCommandError needs separate handling with HTTP 400 for invalid/inaccessible repos
---

## 2026-01-15 - DS-007
- What was implemented: Severity filtering for dep-scanner
- Files changed:
  - `dep-scanner/src/dep_scanner/scanner.py` - Added SEVERITY_ORDER constant, _filter_by_severity function, and severity_threshold parameter to scan_repository
  - `dep-scanner/src/dep_scanner/main.py` - Pass severity_threshold from request to scan_repository
- **Learnings:**
  - severity_threshold was already defined in ScanRequest model from DS-002, just needed to be wired up
  - Use ordered list for severity comparison: ["low", "medium", "high", "critical"]
  - Filter using list index comparison: finding.severity index >= threshold index
  - Summary counts reflect filtered findings, not all findings
  - Default threshold is "low" which shows all findings (no filtering)
---

## 2026-01-15 - DS-008
- What was implemented: Comprehensive test suite for dep-scanner
- Files changed:
  - `dep-scanner/tests/__init__.py` - Test package init
  - `dep-scanner/tests/test_main.py` - 20 tests covering all acceptance criteria
  - `dep-scanner/pyproject.toml` - Added pytest-asyncio to dev dependencies and asyncio_mode config
- **Learnings:**
  - pytest-asyncio>=0.23.0 required for testing FastAPI async endpoints
  - Set `asyncio_mode = "auto"` in [tool.pytest.ini_options] to avoid @pytest.mark.asyncio decorator
  - Use `httpx.AsyncClient` with `ASGITransport(app=app)` for testing FastAPI apps
  - Mock `scan_repository` function at the main module level: `patch("dep_scanner.main.scan_repository")`
  - Test parser functions directly without mocking (unit tests) for npm/pip output parsing
  - GitCommandError can be raised to simulate invalid repository URLs
---

## 2026-01-15 - CH-001
- What was implemented: content-humanizer prompt-based agent with orchagent.json
- Files changed:
  - `content-humanizer/orchagent.json` - Complete agent manifest with type=prompt
- **Learnings:**
  - Prompt-based agents are much simpler - just need orchagent.json with prompt and schemas
  - No need for src/, tests/, Dockerfile, pyproject.toml for prompt-based agents
  - System prompt should include explicit rules for what to avoid (banned words list)
  - input_schema and output_schema use JSON Schema format with minLength/maxLength for validation
  - supported_providers lists which LLM providers can run this agent (openai, anthropic, gemini)
---

## 2026-01-15 - CH-002
- What was implemented: README documentation for content-humanizer agent
- Files changed:
  - `content-humanizer/README.md` - Complete documentation with examples and usage
- **Learnings:**
  - README for prompt-based agents should focus on: what it does, supported providers, example I/O, curl usage
  - Include concrete before/after examples to show the transformation clearly
  - Document limitations (language, character limits) upfront
  - API endpoint pattern: `https://api.orchagent.com/{agent-name}/v1/{endpoint}`
---

## 2026-01-15 - RR-001
- What was implemented: roast-my-resume prompt-based agent with orchagent.json
- Files changed:
  - `roast-my-resume/orchagent.json` - Complete agent manifest with type=prompt, intensity levels
- **Learnings:**
  - Prompt-based agents with enum parameters need the enum in input_schema (intensity levels)
  - System prompt should document how to handle each intensity level distinctly
  - Edge cases for unusual inputs should be documented in the prompt itself
  - Output requiring structured JSON (roast, score, top_fix) needs explicit instruction in prompt
  - Default values for enum parameters are defined in input_schema with "default" key
---

## 2026-01-15 - RR-002
- What was implemented: README documentation for roast-my-resume agent
- Files changed:
  - `roast-my-resume/README.md` - Complete documentation with intensity level examples
- **Learnings:**
  - For agents with multiple modes (intensity levels), include example output for each mode
  - Gordon Ramsay mode examples should channel his distinctive speaking style
  - Table format works well for quick reference of enum options
  - "Best Used For" section helps users understand the agent's value proposition
  - README pattern: What It Does, Supported Providers, Input/Output, Examples, Usage (curl), Best Used For, Limitations
---

## 2026-01-15 - SR-001
- What was implemented: Scaffolded security-review orchestrator project structure
- Files changed:
  - `security-review/orchagent.json` - Agent manifest with type=code and manifest declaring dependencies
  - `security-review/pyproject.toml` - Python project config with fastapi, httpx, gitpython deps
  - `security-review/Dockerfile` - Container config following leak-finder pattern
  - `security-review/src/security_review/__init__.py` - Package init
- **Learnings:**
  - Orchestrator agents use `manifest` field in orchagent.json to declare dependencies
  - manifest.dependencies is an array of `{ "id": "orchagent/agent-name", "version": "v1" }` objects
  - manifest.max_hops controls how deep agent calls can chain (2 for this orchestrator)
  - manifest.timeout_ms should be higher for orchestrators (180000ms vs 60000ms for leaf agents)
  - httpx is needed for making async HTTP calls to other agents
  - default_endpoint for security-review is "review" to match the API pattern
---

## 2026-01-15 - SR-002
- What was implemented: FastAPI app with AgentClient for calling other OrchAgent agents
- Files changed:
  - `security-review/src/security_review/models.py` - Pydantic models (ReviewRequest, ReviewResponse, FindingsCollection, etc.)
  - `security-review/src/security_review/main.py` - FastAPI app with /health and /review endpoints
  - `security-review/src/security_review/agent_client.py` - HTTP client for calling OrchAgent agents
- **Learnings:**
  - AgentClient uses httpx.AsyncClient for async HTTP calls to other agents
  - OrchAgent API URL pattern: `/{agent-name}/{version}/{endpoint}` (e.g., `/leak-finder/v1/scan`)
  - Use async context manager pattern (`async with AgentClient() as client:`) to manage connection lifecycle
  - Base URL configurable via ORCHAGENT_API_URL env var for deployment flexibility
  - Models split finding types by source: SecretFinding (leak-finder), DependencyFinding (dep-scanner), PatternFinding (internal)
  - FindingsCollection groups all findings by category for structured output
  - Stub /review endpoint returns empty results; actual implementation comes in SR-003+
---

## 2026-01-15 - SR-003
- What was implemented: Parallel calls to leak-finder and dep-scanner using asyncio.gather
- Files changed:
  - `security-review/src/security_review/main.py` - Added parallel agent calls, result parsing, summary calculation
- **Learnings:**
  - asyncio.gather executes coroutines concurrently; results are returned in same order as input
  - Wrap each agent call in a try/except to handle failures gracefully (return None on error)
  - Parse agent responses into typed models for consistent structure (SecretFinding, DependencyFinding)
  - leak-finder returns both `findings` (current files) and `history_findings` (git history)
  - scan_mode parameter controls which scans run: "full" runs both, "secrets-only"/"deps-only" runs one
  - Summary calculation iterates through all finding types to count severities
  - For history findings, append "[in git history]" to preview to distinguish from current findings
---

## 2026-01-15 - SR-004
- What was implemented: Frontend security pattern scanner for detecting security anti-patterns
- Files changed:
  - `security-review/src/security_review/scanners/__init__.py` - Scanner package init with exports
  - `security-review/src/security_review/scanners/frontend.py` - Frontend pattern scanner implementation
  - `security-review/src/security_review/git_utils.py` - Git clone utilities (clone_repo, cleanup_repo, cloned_repo context manager)
  - `security-review/src/security_review/main.py` - Integrated frontend scanner into /review endpoint
- **Learnings:**
  - PatternMatch as NamedTuple provides clean pattern definition with name, severity, description, recommendation, regex
  - _is_frontend_file() filters by extension (.tsx, .jsx, .ts, .js, .vue, .svelte) and path (components, pages, etc.)
  - Skip backend paths (/api/, /server/, /backend/) to avoid false positives
  - localStorage patterns for auth tokens are critical severity; direct DB access is high severity
  - Client-side price calculations are medium severity (can be tampered but less critical)
  - Pattern scanning requires local repo clone, so git_utils.py with cloned_repo context manager handles cleanup
  - scan_mode "patterns-only" only runs internal scanners, skipping agent calls to leak-finder/dep-scanner
  - GitCommandError raised from git.exc must be handled separately to return 400 for invalid repos
---

## 2026-01-15 - SR-005
- What was implemented: API security pattern scanner for detecting auth and rate limiting issues
- Files changed:
  - `security-review/src/security_review/scanners/api.py` - API security pattern scanner implementation
  - `security-review/src/security_review/scanners/__init__.py` - Added scan_api_patterns export
  - `security-review/src/security_review/main.py` - Integrated API scanner into /review endpoint
- **Learnings:**
  - FastAPI auth detection requires checking for `Depends()` in route decorator or function signature
  - Need to check multiple lines of context since function signature may span lines after decorator
  - Express auth detection looks for common middleware names: requireAuth, authenticate, isAuthenticated, etc.
  - Exclude health/ping/docs endpoints from missing auth warnings (these are legitimately public)
  - Rate limiter detection checks for imports of slowapi, express-rate-limit, etc. in entry point files
  - Only report missing rate limiter for files that are clearly API servers (contain fastapi/express/etc.)
  - _is_api_file() filters by extension AND path indicators (/api/, /routes/, /routers/, etc.)
  - Exclude test files to avoid false positives from test fixtures
---

## 2026-01-15 - SR-006
- What was implemented: Logging security pattern scanner for detecting sensitive data exposure
- Files changed:
  - `security-review/src/security_review/scanners/logging.py` - New logging pattern scanner with 11 patterns
  - `security-review/src/security_review/scanners/__init__.py` - Added scan_logging_patterns export
  - `security-review/src/security_review/main.py` - Integrated logging scanner into /review endpoint
- **Learnings:**
  - Logging patterns need to cover both JS (console.log) and Python (logger.info, print) codebases
  - err.stack detection needs to check multiple response patterns: res.json(), return {}, detail= etc.
  - HTTPException(detail=str(e)) is a common FastAPI anti-pattern that exposes error internals
  - Spreading error objects (...error) into responses can leak sensitive internal fields
  - traceback.format_exc() in response context is a critical vulnerability
  - Test files get lowered severity (high->low) since logging secrets in tests is less critical
  - Pattern-based approach works well for logging issues since patterns are consistent across codebases
---

## 2026-01-15 - SR-007
- What was implemented: Response aggregation with recommendation generation
- Files changed:
  - `security-review/src/security_review/recommendations.py` - New module for generating actionable recommendations
  - `security-review/src/security_review/main.py` - Integrated recommendation generator
- **Learnings:**
  - Priority scoring for recommendations: secrets > critical deps > auth bypass > dependencies > logging issues
  - Secrets should have fixed high priority (10000), not multiplied by count - each leaked secret is equally critical
  - Other findings multiply base score by count (capped at 5x) since more occurrences = higher urgency
  - Recommendations should be specific with counts: "Rotate 2 exposed AWS keys" not "Rotate exposed secrets"
  - scan_mode filter was already implemented in SR-003; summary calculation in SR-003 as well
  - generate_recommendations() returns empty list for empty findings - handles edge case gracefully
---

## 2026-01-15 - SR-008
- What was implemented: Comprehensive integration tests for security-review orchestrator
- Files changed:
  - `security-review/tests/__init__.py` - Test package init
  - `security-review/tests/test_main.py` - 27 tests covering all acceptance criteria
- **Learnings:**
  - Test organization: separate test classes by component (TestHealthEndpoint, TestReviewEndpoint, TestFrontendPatternScanner, etc.)
  - Mock AgentClient with AsyncMock for async context manager pattern (__aenter__, __aexit__)
  - Use tempfile.TemporaryDirectory fixture for scanner tests that need file system interaction
  - Mock cloned_repo context manager with MagicMock for __enter__/__exit__ since it's sync
  - Pattern scanner tests: write realistic file content to temp files, then verify scanner detects patterns
  - Test scan modes independently: secrets-only should NOT call dep_scanner, patterns-only should NOT call agents
  - Test error handling: agent failures should be graceful (return 200 with empty findings), git errors should return 400
  - Use `from security_review.main import _calculate_summary` to test internal functions directly
  - pytest-asyncio with asyncio_mode="auto" simplifies async test writing (no @pytest.mark.asyncio needed)
---
